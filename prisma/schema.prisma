// RULES::::
// 1. Model names are always singular
// 2. Table maps are to be plural
// 3. No column prefixing i.e. space_title, prop_title, org_title
// 4. Camel cased columns are to mapped to all lowercase and joined by an _ i.e createdAt = created_at
// 5. Author or Creator must always reference the User. 


generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider     = "mysql"
  url          = env("DATABASE_URL")
  relationMode = "prisma"
}

model Account {
  id                String   @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  @db.Text
  access_token      String?  @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  @db.Text
  session_state     String?
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @default(now()) @map("updated_at")
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("sessions")
}

model User {
  id                     String    @id @default(cuid())
  name                   String?
  email                  String?   @unique
  emailVerified          DateTime?
  image                  String?
  createdAt              DateTime  @default(now()) @map("created_at")
  updatedAt              DateTime  @default(now()) @map("updated_at")
  stripeCustomerId       String?   @unique @map("stripe_customer_id")
  stripeSubscriptionId   String?   @unique @map("stripe_subscription_id")
  stripePriceId          String?   @map("stripe_price_id")
  stripeCurrentPeriodEnd DateTime? @map("stripe_current_period_end")
  accounts               Account[]
  sessions               Session[]

  organizations           OrganizationUser[]
  properties              PropertyUser[]
  
  assignedToMeTodos Todo[] @relation("AssignedToMeTodos")
  assignedByMeTodos Todo[] @relation("AssignedByMeTodos")

  @@map("users")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

enum PersonRoles {
  user
  admin
}
enum PropertyRoles {
  admin
  owner
}
model OrganizationUser {
  id              String                  @id @default(cuid())
  user            User                    @relation(fields: [userId], references: [id])
  userId          String

  organization    Organization            @relation(fields: [organizationId], references: [id])
  organizationId  String

  // TODO: Make this a space user when need be
  spaces Space[]

  role            PersonRoles @default(user)
  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  @@index([organizationId])
  @@index([userId])
  @@map("organization_users")
}
model Organization {
  id          String    @id @default(cuid())
  name        String    @unique
  slug        String?    @unique
  description String?

  logo        Image?    @relation(fields: [logoId], references: [id])
  logoId      String?

  users       OrganizationUser[]

  properties Property[]
  spaces Space[]

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([logoId])
  @@map("organizations")
}

model PropertyUser {
  id              String                  @id @default(cuid())
  user            User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String

  property Property @relation("PropertyUsers",fields: [propertyId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  propertyId  String
  
  role            PropertyRoles @default(admin)

  createdProperties Property[] @relation("CreatedByUser")

  createdAt       DateTime                @default(now())
  updatedAt       DateTime                @updatedAt

  @@map("property_users")
  @@index([userId])
  @@index([propertyId])
}

model Property {
  id String @id @default(cuid())
  name String 
  description     String? @db.Text

  address String?
  type String?
  size String?

  // createdById String?
  // createdBy PropertyUser? @relation("CreatedByUser", fields: [createdById], references: [id])
  users PropertyUser[] @relation("PropertyUsers")

  createdById String?
  createdBy PropertyUser? @relation("CreatedByUser", fields: [createdById], references: [id])

  logo        Image?    @relation(fields: [logoId], references: [id])
  logoId     String?

  organization    Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  organizationId  String

  spaces      Space[]

  todos Todo[]

  private     Boolean  @default(false)
  
  createdAt   DateTime?  @default(now())
  updatedAt   DateTime?  @updatedAt

  @@index([logoId])
  @@index([organizationId])
  @@map("properties")
  @@index([createdById])
}
model Image {
  id            String    @id @default(cuid())
  fileKey       String
  fileUrl       String
  property      Property[]
  organization  Organization[]
  space         Space[]

  createdAt   DateTime?  @default(now())
  updatedAt   DateTime?  @updatedAt

  @@map("images")
}


enum ListingStatus {
  draft
  published
}
model Space {
  id              String  @id @default(cuid())
  title           String?
  description     String? @db.Text
  province        String?
  street          String?
  unitNumber      String?
  suburb          String?
  city            String?
  postalCode      String?
  featureImageUrl String?
  price           Int?
  rooms           Int?
  desks           Int?
  bathrooms       Int?
  
  status          ListingStatus  @default(draft)

  organization    Organization  @relation(fields: [organizationId], references: [id])
  organizationId  String

  property    Property?  @relation(fields: [propertyId], references: [id])
  propertyId  String?

  authorId        String?
  author          OrganizationUser?   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  categoryId      String?
  category        Category? @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  typeId          String?
  type            Type?   @relation(fields: [typeId], references: [id], onDelete: Cascade)

  images          Image[]

  todos           Todo[]

  offerings       Offering[]

  highlights      Highlight[]

  amenities       Amenity[]

  createdAt       DateTime? @default(now()) @map("created_at")
  updatedAt       DateTime? @default(now()) @map("updated_at")

  @@index([categoryId])
  @@index([typeId])
  @@index([authorId])
  @@index([propertyId])
  @@map("spaces")
  @@index([organizationId])
}
model Todo {
  id          String      @id @default(cuid())
  title       String
  description String?

  completed Boolean     @default(false)

  parentId    String?
  parent      Todo?       @relation("ChildTodos", fields: [parentId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  
  children    Todo[]      @relation("ChildTodos")

  property    Property?   @relation(fields: [propertyId], references: [id])
  propertyId  String?
  
  space       Space?      @relation(fields: [spaceId], references: [id])
  spaceId     String?

  assignedToId String?
  assignedTo  User? @relation("AssignedToMeTodos", fields: [assignedToId], references: [id], onDelete: Cascade) 

  assignedById String?
  assignedBy  User? @relation("AssignedByMeTodos", fields: [assignedById], references: [id], onDelete: Cascade) 

  createdByPropertyUserId String?
  
  createdAt       DateTime? @default(now()) @map("created_at")
  updatedAt       DateTime? @default(now()) @map("updated_at")

  @@index([parentId])
  @@index([propertyId])
  @@index([spaceId])
  @@index([assignedToId])
  @@index([assignedById])
  @@map("todos")
}
model Category {
  id          String    @id @default(cuid())
  label       String
  description String?
  key         String?
  updatedAt   DateTime  @updatedAt
  createdAt   DateTime  @default(now())
  spaces      Space[]
  @@map("categories")
}


model Offering {
  id        String    @id @default(cuid())
  label     String
  key         String?
  updatedAt DateTime  @updatedAt
  createdAt DateTime  @default(now())
  spaces   Space[]
  @@map("offerings")
}

model Highlight {
  id        String    @id @default(cuid())
  label     String
  key         String?
  icon      String
  updatedAt DateTime  @updatedAt
  createdAt DateTime  @default(now())
  spaces   Space[]
  @@map("highlights")
}

model Amenity {
  id        String    @id @default(cuid())
  label     String
  key         String?
  updatedAt DateTime  @updatedAt
  createdAt DateTime  @default(now())
  spaces   Space[]
  @@map("amenities")
}

model Type {
  id          String    @id @default(cuid())
  label       String
  key         String?
  description String
  icon        String
  updatedAt   DateTime  @updatedAt
  createdAt   DateTime  @default(now())
  spaces     Space[]
  @@map("types")
}
